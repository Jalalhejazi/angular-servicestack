/**
 * @name: angular-servicestack
 * @description: A Service Stack client for AngularJS
 * @version: v0.2.0 - 2013-07-16
 * @link: https://github.com/kkolstad/angular-servicestack
 * @author: Kenneth Kolstad
 * @license: MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){var a;a=angular.module("angular-servicestack",[]),a.provider("serviceStackRestConfig",function(){var a;return a={urlPrefix:"",maxRetries:3,maxDelayBetweenRetries:4e3,unauthorizedFn:null},{setRestConfig:function(b){return angular.extend(a,b)},$get:function(){return a}}}),a.factory("serviceStackRestClient",["serviceStackRestConfig","$http","$q","$timeout","$location","$log",function(a,b,c,d,e,f){var g,h;return h=function(){function b(a){var b,c,d,e,f,g,h,i,j,k;this.response=a,this.success=200<=(b=this.response.status)&&300>b,this.statusCode=this.response.status,this.success&&(this.data=this.response.data),this.success||(this.error=null!=(c=this.response)?null!=(d=c.data)?d.responseStatus:void 0:void 0),!this.success&&(null!=(e=this.response)?null!=(f=e.data)?null!=(g=f.responseStatus)?null!=(h=g.errors)?h.length:void 0:void 0:void 0:void 0)>0&&(this.validationErrors=null!=(i=this.response)?null!=(j=i.data)?null!=(k=j.responseStatus)?k.errors:void 0:void 0:void 0),this.isRetryable()&&this.incrementCollisionCount(),this.headers=this.response.headers,this.config=this.response.config}return b.prototype.collisionCount=function(){var a,b,c;return(null!=(a=this.response)?null!=(b=a.config)?null!=(c=b.data)?c._collisions:void 0:void 0:void 0)||0},b.prototype.getConfig=function(){return this.response.config},b.prototype.hasValidationError=function(){var a;return(null!=(a=this.validationErrors)?a.length:void 0)>0},b.prototype.incrementCollisionCount=function(){var a,b;return this.response.config.data=(null!=(a=this.response)?null!=(b=a.config)?b.data:void 0:void 0)||{},this.response.config.data._collisions=this.collisionCount()+1},b.prototype.isRetryable=function(){var b;return(500===(b=this.statusCode)||503===b?!0:void 0)&&this.collisionCount()<=a.maxRetries},b.prototype.isUnauthenticated=function(){return 401===this.statusCode},b.prototype.isUnhandledError=function(){return!this.success&&!this.isUnauthenticated()&&!this.isRetryable()},b.prototype.toLog=function(){return f.log("ServiceStackResponse:"),f.log(this),f.log("	hasValidationError: "+this.hasValidationError()),f.log("	isUnhandledError:   "+this.isUnhandledError()),f.log("	isUnauthenticated:  "+this.isUnauthenticated()),f.log("	isRetryable:        "+this.isRetryable()),f.log("	collisionCount:     "+this.collisionCount())},b}(),g=function(){function g(){}return g.prototype["delete"]=function(a,b){return null==b&&(b={}),b.method="DELETE",b.url=a,this.execute(b)},g.prototype.get=function(a,b){return null==b&&(b={}),b.method="GET",b.url=a,this.execute(b)},g.prototype.post=function(a,b,c){return null==b&&(b=null),null==c&&(c={}),c.method="POST",c.data=b,c.url=a,this.execute(c)},g.prototype.put=function(a,b,c){return null==b&&(b=null),null==c&&(c={}),c.method="PUT",c.data=b,c.url=a,this.execute(c)},g.prototype.fixUrl=function(b){var c,d;return 0===b.indexOf(a.urlPrefix)?b:(f.log("Fixing url: "+b),c=a.urlPrefix.replace(/\/+$/,""),b=b.replace(/^\/+/,""),d=""+c+"/"+b,f.log("to url: "+c+"/"+b),d)},g.prototype.execute=function(f){var g,i,j,k,l,m;return j=this,l=[],i=[],m=[],f.url=this.fixUrl(f.url),g=c.defer(),k=b(f),k.then(function(a){var b;return b=new h(a),g.resolve(b)},function(a){var b;return b=new h(a),g.reject(b)}),g.promise.success=function(a){return l.push(a),g.promise.then(function(b){return a(b,b.headers,b.config)}),g.promise},g.promise.error=function(a){return i.push(a),g.promise.then(null,function(b){return b.isUnhandledError()&&!b.hasValidationError()?a(b,b.headers,b.config):void 0}),g.promise},g.promise.validation=function(a){return m.push(a),g.promise.then(null,function(b){return b.isUnhandledError()&&b.hasValidationError()?a(b,b.headers,b.config):void 0}),g.promise},g.promise.then(null,function(b){if(b.isUnauthenticated()){if(null!=a.unauthorizedFn&&angular.isFunction(a.unauthorizedFn))return a.unauthorizedFn(b,e);if(null!=i&&angular.isFunction(i))return i(b)}}),g.promise.then(null,function(b){var c;return b.isRetryable()?(c=Math.min(Math.random()*100*Math.pow(4,b.collisionCount()-1),a.maxDelayBetweenRetries),d(function(){var a,c,d,e,f,g,h,k;for(c=j.execute(b.getConfig()),d=0,g=l.length;g>d;d++)a=l[d],c.success(a);for(e=0,h=i.length;h>e;e++)a=i[e],c.error(a);for(f=0,k=m.length;k>f;f++)a=m[f],c.validation(a);return c},c)):void 0}),g.promise},g}(),new g}])}.call(this);